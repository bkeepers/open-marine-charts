#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset
set -x

cd "$(dirname "$0")/.."

REGION=${1:-}

# FIXME: get this from the region
BBOX=-180,-85,180,85
# BBOX=-90,15,-67,85

if [ -z "$REGION" ]; then
  echo "Usage: $0 <region>"
  exit 1
fi

mkdir -p build
mkdir -p cache/build

if [ -d "configs/$REGION" ]; then
  CONFIG=$REGION
  OUTPUT=${2:-$REGION.mbtiles}
  INPUT=""
else
  # remove slash from region name
  REGION_NAME=${REGION//\//_}
  CONFIG=region
  INPUT="--input ${REGION_NAME}-latest.osm.pbf"
  OUTPUT=${2:-$REGION_NAME.mbtiles}

  if ! [ -f data/$REGION_NAME-latest.osm.pbf ]; then
    bin/regions download $REGION
  fi
fi

echo "Building $OUTPUT"
docker compose run --rm -it build \
  --process configs/$CONFIG/process.lua \
  --config  configs/$CONFIG/config.json \
  --store cache/build \
  $INPUT --output build/.tmp.$OUTPUT \
  --bbox $BBOX

# Move the output file to the correct name
mv build/.tmp.$OUTPUT build/$OUTPUT
